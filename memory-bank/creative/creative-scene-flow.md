# åœºæ™¯ç®¡ç†è®¾è®¡

## ğŸ¨ğŸ¨ğŸ¨ ENTERING CREATIVE PHASE: ARCHITECTURE

## éœ€æ±‚åˆ†æ

### å½“å‰é—®é¢˜

1. **ç¼ºå°‘ç»Ÿä¸€åœºæ™¯æµç¨‹ç®¡ç†ï¼š** GameApp ä¸­æœ‰ `preloadScene` æ–¹æ³•ï¼Œä½†æ²¡æœ‰ç»Ÿä¸€çš„åœºæ™¯åˆ‡æ¢æµç¨‹
2. **World çŠ¶æ€ç®¡ç†ä¸æ¸…æ™°ï¼š** åœºæ™¯åˆ‡æ¢æ—¶ World åº”è¯¥ä¿ç•™ã€é‡å»ºè¿˜æ˜¯åˆå¹¶ï¼Ÿ
3. **èµ„æºåŠ è½½/å¸è½½æ—¶æœºä¸æ˜ç¡®ï¼š** ä»€ä¹ˆæ—¶å€™é¢„åŠ è½½ï¼Ÿä»€ä¹ˆæ—¶å€™å¸è½½ï¼Ÿ
4. **åœºæ™¯ç”Ÿå‘½å‘¨æœŸç®¡ç†ç¼ºå¤±ï¼š** åœºæ™¯è¿›å…¥/é€€å‡ºæ—¶çš„æ¸…ç†é€»è¾‘åˆ†æ•£
5. **åœºæ™¯ç±»å‹ä¸æ˜ç¡®ï¼š** ä¸»åœºæ™¯ã€æˆ˜æ–—åœºæ™¯ã€å•†åº—åœºæ™¯ç­‰éœ€è¦ä¸åŒçš„å¤„ç†ç­–ç•¥

### ä½¿ç”¨åœºæ™¯

1. **ä¸»åœºæ™¯ï¼ˆMainï¼‰ï¼š** æ¸¸æˆä¸»ç•Œé¢ï¼Œä¿ç•™ç©å®¶æ•°æ®ï¼Œåˆ‡æ¢åˆ°å…¶ä»–åœºæ™¯åè¿”å›
2. **æˆ˜æ–—åœºæ™¯ï¼ˆBattleï¼‰ï¼š** æˆ˜æ–—å…³å¡ï¼Œè¿›å…¥æ—¶åˆ›å»ºæ•Œäººï¼Œé€€å‡ºæ—¶æ¸…ç†æ‰€æœ‰æ•Œäººï¼Œä¿ç•™ç©å®¶æ•°æ®
3. **å•†åº—åœºæ™¯ï¼ˆShopï¼‰ï¼š** å•†åº—ç•Œé¢ï¼Œè¿›å…¥æ—¶åˆ›å»ºå•†åº— NPCï¼Œé€€å‡ºæ—¶æ¸…ç†
4. **Boss åœºæ™¯ï¼ˆBossï¼‰ï¼š** Boss æˆ˜æ–—ï¼Œè¿›å…¥æ—¶åˆ›å»º Bossï¼Œé€€å‡ºæ—¶æ¸…ç†
5. **åœºæ™¯é¢„åŠ è½½ï¼š** åˆ‡æ¢å‰é¢„åŠ è½½èµ„æºï¼Œé¿å…å¡é¡¿
6. **åœºæ™¯æ¸…ç†ï¼š** åˆ‡æ¢åæ¸…ç†ä¸éœ€è¦çš„èµ„æºï¼Œé‡Šæ”¾å†…å­˜

### çº¦æŸæ¡ä»¶

1. **æ¶æ„çº¦æŸï¼š**
   - ECS World åªå­˜çº¯æ•°æ®ï¼Œä¸ä¾èµ– Creator åœºæ™¯
   - åœºæ™¯åˆ‡æ¢æ—¶ View å±‚éœ€è¦æ¸…ç†ï¼ˆViewManager.clear()ï¼‰
   - èµ„æºç®¡ç†å™¨éœ€è¦æ”¯æŒåœºæ™¯çº§åˆ«çš„èµ„æºå¸è½½
   - å­˜æ¡£ç³»ç»Ÿéœ€è¦çŸ¥é“åœºæ™¯çŠ¶æ€

2. **æ€§èƒ½çº¦æŸï¼š**
   - åœºæ™¯åˆ‡æ¢ä¸åº”è¯¥é˜»å¡ä¸»çº¿ç¨‹ï¼ˆå¼‚æ­¥åˆ‡æ¢ï¼‰
   - èµ„æºé¢„åŠ è½½åº”è¯¥å¹¶è¡Œæ‰§è¡Œ
   - é¿å…é‡å¤åŠ è½½èµ„æº

3. **æ•°æ®æµçº¦æŸï¼š**
   - åœºæ™¯åˆ‡æ¢æ—¶ï¼ŒWorld çŠ¶æ€ç®¡ç†ç­–ç•¥éœ€è¦æ˜ç¡®
   - ç©å®¶æ•°æ®ï¼ˆInventoryã€Equipmentã€LevelExperienceï¼‰åº”è¯¥ä¿ç•™
   - åœºæ™¯ç‰¹å®šæ•°æ®ï¼ˆæ•Œäººã€NPCï¼‰åº”è¯¥åœ¨åœºæ™¯é€€å‡ºæ—¶æ¸…ç†

---

## è®¾è®¡é€‰é¡¹

### é€‰é¡¹ 1ï¼šåœºæ™¯çŠ¶æ€æœº + World ä¿ç•™ç­–ç•¥ â­ æ¨è

**è®¾è®¡æ€è·¯ï¼š**
- åˆ›å»ºä¸€ä¸ª `SceneFlow` ç±»ç®¡ç†åœºæ™¯æµç¨‹
- World åœ¨æ•´ä¸ªæ¸¸æˆç”Ÿå‘½å‘¨æœŸä¸­ä¿ç•™ï¼Œåœºæ™¯åˆ‡æ¢æ—¶åªæ¸…ç†åœºæ™¯ç‰¹å®šçš„å®ä½“
- ä½¿ç”¨åœºæ™¯æ ‡è¯†ç»„ä»¶ï¼ˆSceneTagComponentï¼‰æ ‡è®°åœºæ™¯ç‰¹å®šçš„å®ä½“
- åœºæ™¯åˆ‡æ¢æ—¶æ¸…ç†æ‰€æœ‰å¸¦å½“å‰åœºæ™¯ Tag çš„å®ä½“

**ç»“æ„ï¼š**
```typescript
// åœºæ™¯ç±»å‹
enum SceneType {
    Main = 'main',
    Battle = 'battle',
    Shop = 'shop',
    Boss = 'boss'
}

// åœºæ™¯æ ‡è¯†ç»„ä»¶ï¼ˆæ ‡è®°åœºæ™¯ç‰¹å®šçš„å®ä½“ï¼‰
@component
class SceneTagComponent {
    sceneType: SceneType;
}

// SceneFlow ç±»
class SceneFlow {
    private currentScene: SceneType = SceneType.Main;
    private world: World;
    private resourceManager: ResourceManager;
    private resourcePreloader: ResourcePreloader;
    private viewManager: ViewManager;
    
    // åœºæ™¯åˆ‡æ¢
    async switchScene(targetScene: SceneType, options?: SceneSwitchOptions): Promise<void>
    
    // åœºæ™¯é¢„åŠ è½½
    async preloadScene(sceneType: SceneType): Promise<void>
    
    // åœºæ™¯æ¸…ç†
    private cleanupScene(sceneType: SceneType): void
    
    // åœºæ™¯åˆå§‹åŒ–
    private initializeScene(sceneType: SceneType): void
}

// åœºæ™¯åˆ‡æ¢æµç¨‹
async switchScene(targetScene: SceneType) {
    // 1. é¢„åŠ è½½ç›®æ ‡åœºæ™¯èµ„æº
    await this.preloadScene(targetScene);
    
    // 2. æ¸…ç†å½“å‰åœºæ™¯ï¼ˆä¿ç•™ç©å®¶æ•°æ®ï¼‰
    this.cleanupScene(this.currentScene);
    
    // 3. æš‚åœ ECS æ›´æ–°ï¼ˆå¯é€‰ï¼‰
    // this.pauseECS();
    
    // 4. åŠ è½½ Creator åœºæ™¯ï¼ˆä½¿ç”¨ Cocos Creator APIï¼‰
    await this.loadCreatorScene(targetScene);
    
    // 5. åˆå§‹åŒ–æ–°åœºæ™¯ï¼ˆåˆ›å»ºåœºæ™¯ç‰¹å®šå®ä½“ï¼‰
    this.initializeScene(targetScene);
    
    // 6. æ¢å¤ ECS æ›´æ–°
    // this.resumeECS();
    
    // 7. æ›´æ–°å½“å‰åœºæ™¯
    this.currentScene = targetScene;
}

// åœºæ™¯æ¸…ç†ï¼ˆåªæ¸…ç†åœºæ™¯ç‰¹å®šçš„å®ä½“ï¼‰
private cleanupScene(sceneType: SceneType): void {
    // æŸ¥è¯¢æ‰€æœ‰å¸¦å½“å‰åœºæ™¯ Tag çš„å®ä½“
    const sceneQuery = this.world.createQuery({
        all: [SceneTagComponent]
    });
    
    sceneQuery.forEach(entity => {
        const tag = entity.getComponent(SceneTagComponent);
        if (tag.sceneType === sceneType) {
            // æ¸…ç†å®ä½“ï¼ˆECS ä¼šè‡ªåŠ¨æ¸…ç†ç»„ä»¶å’Œè§†å›¾ï¼‰
            this.world.destroyEntity(entity);
        }
    });
    
    // æ¸…ç† View å±‚ï¼ˆåœºæ™¯åˆ‡æ¢æ—¶æ¸…ç†æ‰€æœ‰ Viewï¼‰
    this.viewManager.clear();
    
    // å¸è½½åœºæ™¯ç‰¹å®šèµ„æºï¼ˆå¯é€‰ï¼‰
    // this.resourceManager.unloadSceneResources(sceneType);
}

// åœºæ™¯åˆå§‹åŒ–ï¼ˆåˆ›å»ºåœºæ™¯ç‰¹å®šå®ä½“ï¼‰
private initializeScene(sceneType: SceneType): void {
    switch (sceneType) {
        case SceneType.Battle:
            // åˆ›å»ºæ•Œäººå®ä½“
            this.createBattleEntities();
            break;
        case SceneType.Shop:
            // åˆ›å»ºå•†åº— NPC å®ä½“
            this.createShopEntities();
            break;
        case SceneType.Boss:
            // åˆ›å»º Boss å®ä½“
            this.createBossEntities();
            break;
    }
}
```

**ä¼˜ç‚¹ï¼š**
- âœ… World çŠ¶æ€ä¿ç•™ï¼Œç©å®¶æ•°æ®ä¸ä¼šä¸¢å¤±
- âœ… åœºæ™¯åˆ‡æ¢æµç¨‹æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
- âœ… åœºæ™¯ç‰¹å®šçš„å®ä½“ç®¡ç†ç®€å•ï¼ˆé€šè¿‡ Tag ç»„ä»¶ï¼‰
- âœ… æ”¯æŒåœºæ™¯é¢„åŠ è½½ï¼Œç”¨æˆ·ä½“éªŒå¥½
- âœ… ä¸å­˜æ¡£ç³»ç»Ÿå…¼å®¹ï¼ˆWorld å§‹ç»ˆå­˜åœ¨ï¼‰

**ç¼ºç‚¹ï¼š**
- âš ï¸ éœ€è¦æ‰‹åŠ¨ç®¡ç† SceneTagComponentï¼ˆå®¹æ˜“é—æ¼ï¼‰
- âš ï¸ åœºæ™¯æ¸…ç†é€»è¾‘éœ€è¦æ˜ç¡®å“ªäº›å®ä½“å±äºåœºæ™¯
- âš ï¸ World ä¸­çš„å®ä½“æ•°é‡å¯èƒ½ä¼šç´¯ç§¯ï¼ˆå¦‚æœä¸åŠæ—¶æ¸…ç†ï¼‰

---

### é€‰é¡¹ 2ï¼šåœºæ™¯çŠ¶æ€æœº + World é‡å»ºç­–ç•¥

**è®¾è®¡æ€è·¯ï¼š**
- åœºæ™¯åˆ‡æ¢æ—¶é‡å»º World
- ä½¿ç”¨å­˜æ¡£ç³»ç»Ÿä¿å­˜ç©å®¶æ•°æ®
- åœºæ™¯åˆ‡æ¢æ—¶åºåˆ—åŒ–ç©å®¶æ•°æ®ï¼Œé‡å»º World åååºåˆ—åŒ–

**ç»“æ„ï¼š**
```typescript
class SceneFlow {
    async switchScene(targetScene: SceneType): Promise<void> {
        // 1. ä¿å­˜ç©å®¶æ•°æ®ï¼ˆåºåˆ—åŒ–ï¼‰
        const playerData = this.savePlayerData();
        
        // 2. æ¸…ç†å½“å‰åœºæ™¯
        this.viewManager.clear();
        this.world.destroy();
        
        // 3. é¢„åŠ è½½ç›®æ ‡åœºæ™¯èµ„æº
        await this.preloadScene(targetScene);
        
        // 4. é‡å»º World
        this.world = new World({ ... });
        this.setupSystems(this.world);
        
        // 5. æ¢å¤ç©å®¶æ•°æ®ï¼ˆååºåˆ—åŒ–ï¼‰
        this.restorePlayerData(playerData);
        
        // 6. åŠ è½½ Creator åœºæ™¯
        await this.loadCreatorScene(targetScene);
        
        // 7. åˆå§‹åŒ–æ–°åœºæ™¯
        this.initializeScene(targetScene);
    }
}
```

**ä¼˜ç‚¹ï¼š**
- âœ… World å®Œå…¨å¹²å‡€ï¼Œä¸ä¼šæœ‰é—ç•™æ•°æ®
- âœ… åœºæ™¯åˆ‡æ¢é€»è¾‘ç®€å•ï¼ˆç›´æ¥é‡å»ºï¼‰

**ç¼ºç‚¹ï¼š**
- âŒ ç©å®¶æ•°æ®éœ€è¦é¢‘ç¹åºåˆ—åŒ–/ååºåˆ—åŒ–ï¼ˆæ€§èƒ½å¼€é”€ï¼‰
- âŒ åœºæ™¯åˆ‡æ¢æ—¶é—´é•¿ï¼ˆé‡å»º World + æ¢å¤æ•°æ®ï¼‰
- âŒ éœ€è¦ä¿®æ”¹å­˜æ¡£ç³»ç»Ÿæ”¯æŒä¸´æ—¶æ•°æ®ä¿å­˜
- âŒ å¤æ‚ç³»ç»Ÿçš„çŠ¶æ€å¯èƒ½éš¾ä»¥å®Œæ•´ä¿å­˜

**è¯„ä¼°ï¼š** âŒ ä¸æ¨è
- æ€§èƒ½å¼€é”€å¤§
- å®ç°å¤æ‚
- ä¸ç°æœ‰å­˜æ¡£ç³»ç»Ÿè®¾è®¡å†²çªï¼ˆå­˜æ¡£ç³»ç»Ÿè®¾è®¡ä¸º"é‡å»º World"ï¼Œä½†ä¸åº”è¯¥ç”¨äºåœºæ™¯åˆ‡æ¢ï¼‰

---

### é€‰é¡¹ 3ï¼šåœºæ™¯çŠ¶æ€æœº + World åˆ†åŒºç­–ç•¥

**è®¾è®¡æ€è·¯ï¼š**
- ä½¿ç”¨å¤šä¸ª Worldï¼ˆä¸» World + åœºæ™¯ Worldï¼‰
- ä¸» World å­˜å‚¨ç©å®¶æ•°æ®ï¼ˆé•¿æœŸä¿ç•™ï¼‰
- åœºæ™¯ World å­˜å‚¨åœºæ™¯ç‰¹å®šæ•°æ®ï¼ˆåœºæ™¯åˆ‡æ¢æ—¶é‡å»ºï¼‰

**ç»“æ„ï¼š**
```typescript
class SceneFlow {
    private mainWorld: World; // ç©å®¶æ•°æ®
    private sceneWorld: World; // åœºæ™¯æ•°æ®
    
    async switchScene(targetScene: SceneType): Promise<void> {
        // 1. æ¸…ç†åœºæ™¯ World
        this.sceneWorld.destroy();
        this.sceneWorld = new World({ ... });
        
        // 2. é¢„åŠ è½½èµ„æº
        await this.preloadScene(targetScene);
        
        // 3. åˆå§‹åŒ–åœºæ™¯ World
        this.initializeSceneWorld(targetScene);
        
        // 4. åŠ è½½ Creator åœºæ™¯
        await this.loadCreatorScene(targetScene);
    }
}
```

**ä¼˜ç‚¹ï¼š**
- âœ… ç©å®¶æ•°æ®å’Œåœºæ™¯æ•°æ®å®Œå…¨åˆ†ç¦»
- âœ… åœºæ™¯åˆ‡æ¢æ—¶åªé‡å»ºåœºæ™¯ Worldï¼ˆæ€§èƒ½å¥½ï¼‰

**ç¼ºç‚¹ï¼š**
- âŒ éœ€è¦ä¿®æ”¹ç°æœ‰æ¶æ„ï¼ˆGameApp éœ€è¦ç®¡ç†ä¸¤ä¸ª Worldï¼‰
- âŒ ç³»ç»Ÿéœ€è¦çŸ¥é“æŸ¥è¯¢å“ªä¸ª Worldï¼ˆå¤æ‚åº¦é«˜ï¼‰
- âŒ åœºæ™¯æ•°æ®å’Œç©å®¶æ•°æ®äº¤äº’å›°éš¾ï¼ˆè·¨ World é€šä¿¡ï¼‰
- âŒ ä¸ç°æœ‰ç³»ç»Ÿä¸å…¼å®¹ï¼ˆæ‰€æœ‰ç³»ç»Ÿéƒ½å‡è®¾åªæœ‰ä¸€ä¸ª Worldï¼‰

**è¯„ä¼°ï¼š** âŒ ä¸æ¨è
- æ¶æ„æ”¹åŠ¨å¤ªå¤§
- ä¸ç°æœ‰è®¾è®¡ä¸å…¼å®¹
- è·¨ World é€šä¿¡å¤æ‚

---

### é€‰é¡¹ 4ï¼šæ··åˆç­–ç•¥ï¼ˆåœºæ™¯ World + ç©å®¶æ•°æ®åŒæ­¥ï¼‰

**è®¾è®¡æ€è·¯ï¼š**
- ä¸» World å­˜å‚¨ç©å®¶æ•°æ®ï¼ˆé•¿æœŸä¿ç•™ï¼‰
- åœºæ™¯ World å­˜å‚¨åœºæ™¯æ•°æ®ï¼ˆåœºæ™¯åˆ‡æ¢æ—¶é‡å»ºï¼‰
- ç©å®¶å®ä½“åŒæ—¶å­˜åœ¨äºä¸¤ä¸ª Worldï¼ˆæ•°æ®åŒæ­¥ï¼‰

**ç»“æ„ï¼š**
```typescript
class SceneFlow {
    private mainWorld: World; // ç©å®¶æ•°æ®
    private sceneWorld: World; // åœºæ™¯æ•°æ®
    
    // ç©å®¶æ•°æ®åŒæ­¥
    syncPlayerData(): void {
        // ä» mainWorld åŒæ­¥ç©å®¶æ•°æ®åˆ° sceneWorld
    }
}
```

**ä¼˜ç‚¹ï¼š**
- âœ… æ•°æ®åˆ†ç¦»æ¸…æ™°
- âœ… åœºæ™¯åˆ‡æ¢æ€§èƒ½å¥½

**ç¼ºç‚¹ï¼š**
- âŒ æ•°æ®åŒæ­¥é€»è¾‘å¤æ‚
- âŒ å®¹æ˜“å‡ºç°æ•°æ®ä¸ä¸€è‡´
- âŒ æ¶æ„æ”¹åŠ¨å¤ªå¤§

**è¯„ä¼°ï¼š** âŒ ä¸æ¨è
- æ•°æ®åŒæ­¥å¤æ‚
- å®¹æ˜“å‡ºç°ä¸ä¸€è‡´

---

## æ¨èæ–¹æ¡ˆï¼šé€‰é¡¹ 1ï¼ˆåœºæ™¯çŠ¶æ€æœº + World ä¿ç•™ç­–ç•¥ï¼‰

### ç†ç”±

1. **æœ€å°æ”¹åŠ¨ï¼š** ä¸ç°æœ‰æ¶æ„å…¼å®¹ï¼Œä¸éœ€è¦ä¿®æ”¹ GameApp çš„æ ¸å¿ƒé€»è¾‘
2. **æ€§èƒ½å¥½ï¼š** World ä¿ç•™ï¼Œåœºæ™¯åˆ‡æ¢æ—¶åªéœ€è¦æ¸…ç†åœºæ™¯ç‰¹å®šå®ä½“
3. **æ˜“äºç»´æŠ¤ï¼š** åœºæ™¯åˆ‡æ¢æµç¨‹æ¸…æ™°ï¼Œä½¿ç”¨ Tag ç»„ä»¶æ ‡è®°åœºæ™¯å®ä½“
4. **ä¸å­˜æ¡£å…¼å®¹ï¼š** World å§‹ç»ˆå­˜åœ¨ï¼Œå­˜æ¡£ç³»ç»Ÿæ— éœ€ä¿®æ”¹

### å®ç°ç»†èŠ‚

#### 1. åœºæ™¯æ ‡è¯†ç»„ä»¶

```typescript
// gameplay/components/SceneTag.ts
import { component } from '@bl-framework/ecs';

export enum SceneType {
    Main = 'main',
    Battle = 'battle',
    Shop = 'shop',
    Boss = 'boss'
}

@component
export class SceneTagComponent {
    sceneType: SceneType;
    
    constructor(sceneType: SceneType = SceneType.Main) {
        this.sceneType = sceneType;
    }
}
```

#### 2. SceneFlow ç±»ç»“æ„

```typescript
// app/SceneFlow.ts
import { World } from '@bl-framework/ecs';
import { SceneType, SceneTagComponent } from '../gameplay/components/SceneTag';
import { ResourceManager } from '../presentation/ResourceManager';
import { ResourcePreloader } from '../presentation/ResourcePreloader';
import { ViewManager } from '../presentation/ViewManager';
import { ScenePreloadConfigs } from '../data/configs/resource-preload';
import { director, Scene as CCScene } from 'cc';

export interface SceneSwitchOptions {
    /** æ˜¯å¦é¢„åŠ è½½èµ„æºï¼ˆé»˜è®¤ trueï¼‰ */
    preload?: boolean;
    /** æ˜¯å¦æ¸…ç†å½“å‰åœºæ™¯ï¼ˆé»˜è®¤ trueï¼‰ */
    cleanup?: boolean;
    /** åœºæ™¯åˆ‡æ¢å®Œæˆå›è°ƒ */
    onComplete?: () => void;
    /** åœºæ™¯åˆ‡æ¢å¤±è´¥å›è°ƒ */
    onError?: (error: Error) => void;
}

export class SceneFlow {
    private currentScene: SceneType = SceneType.Main;
    private world: World;
    private resourceManager: ResourceManager;
    private resourcePreloader: ResourcePreloader;
    private viewManager: ViewManager;
    private gameApp: GameApp;
    
    constructor(
        world: World,
        resourceManager: ResourceManager,
        resourcePreloader: ResourcePreloader,
        viewManager: ViewManager,
        gameApp: GameApp
    ) {
        this.world = world;
        this.resourceManager = resourceManager;
        this.resourcePreloader = resourcePreloader;
        this.viewManager = viewManager;
        this.gameApp = gameApp;
    }
    
    /**
     * è·å–å½“å‰åœºæ™¯
     */
    getCurrentScene(): SceneType {
        return this.currentScene;
    }
    
    /**
     * åˆ‡æ¢åœºæ™¯
     */
    async switchScene(targetScene: SceneType, options: SceneSwitchOptions = {}): Promise<void> {
        const {
            preload = true,
            cleanup = true,
            onComplete,
            onError
        } = options;
        
        try {
            // 1. é¢„åŠ è½½ç›®æ ‡åœºæ™¯èµ„æº
            if (preload) {
                await this.preloadScene(targetScene);
            }
            
            // 2. æ¸…ç†å½“å‰åœºæ™¯ï¼ˆä¿ç•™ç©å®¶æ•°æ®ï¼‰
            if (cleanup) {
                this.cleanupScene(this.currentScene);
            }
            
            // 3. åŠ è½½ Creator åœºæ™¯ï¼ˆä½¿ç”¨ Cocos Creator APIï¼‰
            await this.loadCreatorScene(targetScene);
            
            // 4. åˆå§‹åŒ–æ–°åœºæ™¯ï¼ˆåˆ›å»ºåœºæ™¯ç‰¹å®šå®ä½“ï¼‰
            this.initializeScene(targetScene);
            
            // 5. æ›´æ–°å½“å‰åœºæ™¯
            this.currentScene = targetScene;
            
            // 6. è°ƒç”¨å®Œæˆå›è°ƒ
            if (onComplete) {
                onComplete();
            }
        } catch (error) {
            console.error(`[SceneFlow] Failed to switch scene to ${targetScene}:`, error);
            if (onError) {
                onError(error as Error);
            }
            throw error;
        }
    }
    
    /**
     * é¢„åŠ è½½åœºæ™¯èµ„æº
     */
    async preloadScene(sceneType: SceneType): Promise<void> {
        const config = ScenePreloadConfigs[sceneType];
        if (config) {
            await this.resourcePreloader.preloadParallel(
                config,
                (progress) => {
                    console.log(`[SceneFlow] Preloading ${sceneType}: ${(progress * 100).toFixed(1)}%`);
                    // TODO: æ›´æ–° UI åŠ è½½è¿›åº¦æ¡
                }
            );
        }
    }
    
    /**
     * åŠ è½½ Creator åœºæ™¯
     */
    private async loadCreatorScene(sceneType: SceneType): Promise<void> {
        const sceneName = this.getSceneName(sceneType);
        
        return new Promise<void>((resolve, reject) => {
            director.loadScene(sceneName, (error: Error | null) => {
                if (error) {
                    reject(error);
                } else {
                    resolve();
                }
            });
        });
    }
    
    /**
     * è·å–åœºæ™¯åç§°ï¼ˆä» SceneType è½¬æ¢ä¸º Creator åœºæ™¯åç§°ï¼‰
     */
    private getSceneName(sceneType: SceneType): string {
        const sceneNameMap: Record<SceneType, string> = {
            [SceneType.Main]: 'scene-main',
            [SceneType.Battle]: 'scene-battle',
            [SceneType.Shop]: 'scene-shop',
            [SceneType.Boss]: 'scene-boss'
        };
        return sceneNameMap[sceneType] || 'scene-main';
    }
    
    /**
     * æ¸…ç†åœºæ™¯ï¼ˆåªæ¸…ç†åœºæ™¯ç‰¹å®šçš„å®ä½“ï¼Œä¿ç•™ç©å®¶æ•°æ®ï¼‰
     */
    private cleanupScene(sceneType: SceneType): void {
        // æŸ¥è¯¢æ‰€æœ‰å¸¦å½“å‰åœºæ™¯ Tag çš„å®ä½“
        const sceneQuery = this.world.createQuery({
            all: [SceneTagComponent]
        });
        
        const entitiesToDestroy: any[] = [];
        sceneQuery.forEach(entity => {
            const tag = entity.getComponent(SceneTagComponent);
            if (tag && tag.sceneType === sceneType) {
                entitiesToDestroy.push(entity);
            }
        });
        
        // é”€æ¯åœºæ™¯ç‰¹å®šå®ä½“
        entitiesToDestroy.forEach(entity => {
            this.world.destroyEntity(entity);
        });
        
        // æ¸…ç† View å±‚ï¼ˆåœºæ™¯åˆ‡æ¢æ—¶æ¸…ç†æ‰€æœ‰ Viewï¼‰
        this.viewManager.clear();
        
        // å¸è½½åœºæ™¯ç‰¹å®šèµ„æºï¼ˆå¯é€‰ï¼‰
        // this.resourceManager.unloadSceneResources(sceneType);
    }
    
    /**
     * åˆå§‹åŒ–åœºæ™¯ï¼ˆåˆ›å»ºåœºæ™¯ç‰¹å®šå®ä½“ï¼‰
     */
    private initializeScene(sceneType: SceneType): void {
        switch (sceneType) {
            case SceneType.Main:
                this.createMainSceneEntities();
                break;
            case SceneType.Battle:
                this.createBattleSceneEntities();
                break;
            case SceneType.Shop:
                this.createShopSceneEntities();
                break;
            case SceneType.Boss:
                this.createBossSceneEntities();
                break;
        }
    }
    
    /**
     * åˆ›å»ºä¸»åœºæ™¯å®ä½“
     */
    private createMainSceneEntities(): void {
        // ä¸»åœºæ™¯é€šå¸¸åªéœ€è¦ç©å®¶å®ä½“ï¼ˆå·²åœ¨ World ä¸­ï¼‰
        // å¦‚æœéœ€è¦ NPC æˆ–å…¶ä»–å®ä½“ï¼Œåœ¨è¿™é‡Œåˆ›å»º
    }
    
    /**
     * åˆ›å»ºæˆ˜æ–—åœºæ™¯å®ä½“
     */
    private createBattleSceneEntities(): void {
        // åˆ›å»ºæ•Œäººå®ä½“ï¼ˆç¤ºä¾‹ï¼‰
        // const enemyEntity = this.world.createEntity();
        // enemyEntity.addComponent(SceneTagComponent, SceneType.Battle);
        // enemyEntity.addComponent(TransformComponent, { x: 100, y: 100 });
        // enemyEntity.addComponent(HPComponent, { cur: 100, max: 100 });
        // ... å…¶ä»–ç»„ä»¶
    }
    
    /**
     * åˆ›å»ºå•†åº—åœºæ™¯å®ä½“
     */
    private createShopSceneEntities(): void {
        // åˆ›å»ºå•†åº— NPC å®ä½“ï¼ˆç¤ºä¾‹ï¼‰
        // const shopNPC = this.world.createEntity();
        // shopNPC.addComponent(SceneTagComponent, SceneType.Shop);
        // ... å…¶ä»–ç»„ä»¶
    }
    
    /**
     * åˆ›å»º Boss åœºæ™¯å®ä½“
     */
    private createBossSceneEntities(): void {
        // åˆ›å»º Boss å®ä½“ï¼ˆç¤ºä¾‹ï¼‰
        // const bossEntity = this.world.createEntity();
        // bossEntity.addComponent(SceneTagComponent, SceneType.Boss);
        // ... å…¶ä»–ç»„ä»¶
    }
}
```

#### 3. é›†æˆåˆ° GameApp

```typescript
// app/GameApp.ts
export class GameApp extends Component {
    private sceneFlow!: SceneFlow;
    
    async onLoad() {
        // ... ç°æœ‰åˆå§‹åŒ–ä»£ç  ...
        
        // åˆå§‹åŒ–åœºæ™¯æµç¨‹ç®¡ç†å™¨
        this.sceneFlow = new SceneFlow(
            this.world,
            this.resourceManager,
            this.resourcePreloader,
            this.viewManager,
            this
        );
    }
    
    /**
     * åˆ‡æ¢åœºæ™¯ï¼ˆå§”æ‰˜ç»™ SceneFlowï¼‰
     */
    public async switchScene(sceneType: SceneType, options?: SceneSwitchOptions): Promise<void> {
        return this.sceneFlow.switchScene(sceneType, options);
    }
    
    /**
     * è·å–å½“å‰åœºæ™¯
     */
    public getCurrentScene(): SceneType {
        return this.sceneFlow.getCurrentScene();
    }
}
```

### å®æ–½æŒ‡å—

#### é˜¶æ®µ 1ï¼šåˆ›å»º SceneTag ç»„ä»¶

1. åˆ›å»º `gameplay/components/SceneTag.ts`
2. å®šä¹‰ `SceneType` æšä¸¾
3. å®šä¹‰ `SceneTagComponent` ç»„ä»¶

#### é˜¶æ®µ 2ï¼šå®ç° SceneFlow ç±»

1. åˆ›å»º `app/SceneFlow.ts`
2. å®ç°åœºæ™¯åˆ‡æ¢æµç¨‹
3. å®ç°åœºæ™¯æ¸…ç†é€»è¾‘
4. å®ç°åœºæ™¯åˆå§‹åŒ–é€»è¾‘

#### é˜¶æ®µ 3ï¼šé›†æˆåˆ° GameApp

1. åœ¨ `GameApp.onLoad()` ä¸­åˆå§‹åŒ– `SceneFlow`
2. æä¾› `switchScene()` å’Œ `getCurrentScene()` æ–¹æ³•
3. ç§»é™¤ `GameApp.preloadScene()` æ–¹æ³•ï¼ˆç”± SceneFlow ç®¡ç†ï¼‰

#### é˜¶æ®µ 4ï¼šåœºæ™¯å®ä½“åˆ›å»º

1. åœ¨æ‰€æœ‰åœºæ™¯ç‰¹å®šçš„å®ä½“ä¸Šæ·»åŠ  `SceneTagComponent`
2. ç©å®¶å®ä½“**ä¸æ·»åŠ ** `SceneTagComponent`ï¼ˆä¿ç•™ï¼‰
3. å®ç°å„åœºæ™¯çš„å®ä½“åˆ›å»ºé€»è¾‘

#### é˜¶æ®µ 5ï¼šæµ‹è¯•å’ŒéªŒè¯

1. æµ‹è¯•åœºæ™¯åˆ‡æ¢æµç¨‹
2. éªŒè¯ç©å®¶æ•°æ®ä¿ç•™
3. éªŒè¯åœºæ™¯ç‰¹å®šå®ä½“æ¸…ç†
4. éªŒè¯èµ„æºåŠ è½½/å¸è½½

### æ³¨æ„äº‹é¡¹

1. **ç©å®¶å®ä½“ç®¡ç†ï¼š**
   - ç©å®¶å®ä½“**ä¸åº”è¯¥**æ·»åŠ  `SceneTagComponent`
   - ç©å®¶å®ä½“åº”è¯¥åœ¨æ¸¸æˆå¯åŠ¨æ—¶åˆ›å»ºï¼Œåœ¨æ•´ä¸ªæ¸¸æˆç”Ÿå‘½å‘¨æœŸä¸­ä¿ç•™

2. **åœºæ™¯å®ä½“ç®¡ç†ï¼š**
   - æ‰€æœ‰åœºæ™¯ç‰¹å®šçš„å®ä½“ï¼ˆæ•Œäººã€NPCã€é“å…·ç­‰ï¼‰éƒ½åº”è¯¥æ·»åŠ  `SceneTagComponent`
   - åœºæ™¯åˆ‡æ¢æ—¶ï¼Œè¿™äº›å®ä½“ä¼šè¢«è‡ªåŠ¨æ¸…ç†

3. **èµ„æºç®¡ç†ï¼š**
   - åœºæ™¯åˆ‡æ¢æ—¶ï¼ŒView å±‚ä¼šè¢«æ¸…ç†ï¼ˆ`viewManager.clear()`ï¼‰
   - èµ„æºç®¡ç†å™¨å¯ä»¥é€‰æ‹©å¸è½½åœºæ™¯ç‰¹å®šèµ„æºï¼Œä½†éœ€è¦è°¨æ…ï¼ˆé¿å…é‡å¤åŠ è½½ï¼‰

4. **å­˜æ¡£å…¼å®¹ï¼š**
   - å­˜æ¡£ç³»ç»Ÿåº”è¯¥åªä¿å­˜ç©å®¶æ•°æ®ï¼Œä¸ä¿å­˜åœºæ™¯ç‰¹å®šå®ä½“
   - è¯»æ¡£åï¼Œéœ€è¦æ ¹æ®å½“å‰åœºæ™¯é‡æ–°åˆ›å»ºåœºæ™¯ç‰¹å®šå®ä½“

---

## ğŸ¨ğŸ¨ğŸ¨ EXITING CREATIVE PHASE

## æ€»ç»“

**æ¨èæ–¹æ¡ˆï¼š** åœºæ™¯çŠ¶æ€æœº + World ä¿ç•™ç­–ç•¥

**æ ¸å¿ƒè®¾è®¡ï¼š**
- ä½¿ç”¨ `SceneFlow` ç±»ç®¡ç†åœºæ™¯æµç¨‹
- World åœ¨æ•´ä¸ªæ¸¸æˆç”Ÿå‘½å‘¨æœŸä¸­ä¿ç•™
- ä½¿ç”¨ `SceneTagComponent` æ ‡è®°åœºæ™¯ç‰¹å®šå®ä½“
- åœºæ™¯åˆ‡æ¢æ—¶æ¸…ç†å¸¦å½“å‰åœºæ™¯ Tag çš„å®ä½“ï¼Œä¿ç•™ç©å®¶æ•°æ®

**å®æ–½æ­¥éª¤ï¼š**
1. åˆ›å»º SceneTag ç»„ä»¶
2. å®ç° SceneFlow ç±»
3. é›†æˆåˆ° GameApp
4. åœºæ™¯å®ä½“åˆ›å»ºï¼ˆæ·»åŠ  SceneTagComponentï¼‰
5. æµ‹è¯•å’ŒéªŒè¯

**å…³é”®çº¦æŸï¼š**
- ç©å®¶å®ä½“ä¸æ·»åŠ  SceneTagComponentï¼ˆä¿ç•™ï¼‰
- åœºæ™¯ç‰¹å®šå®ä½“å¿…é¡»æ·»åŠ  SceneTagComponentï¼ˆè‡ªåŠ¨æ¸…ç†ï¼‰
- åœºæ™¯åˆ‡æ¢æ—¶æ¸…ç† View å±‚ï¼Œä¿ç•™ World çŠ¶æ€
